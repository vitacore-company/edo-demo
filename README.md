# ЦДО ОМС

# 1 НАЧАЛЬНЫЕ ТРЕБОВАНИЯ
Для тестового ознакомления с ЦДО ОМС, роли сервера установки и ПК локального пользователя могут быть объединены на одной машине.
## 1.1	ТРЕБОВАНИЯ К СЕРВЕРУ УСТАНОВКИ
Перед инсталляцией ЦДО ОМС на сервере, необходимо убедится, наличия на нем:
- [docker](https://docs.docker.com/engine/install);
- [docker-compose](https://docs.docker.com/compose/install).
## 1.2	ТРЕБОВАНИЯ К ПК ЛОКАЛЬНОГО ПОЛЬЗОВАТЕЛЯ  
Для эксплуатации ЦДО ОМС на машине пользователя должны быть выполнены следующие условия:
- Установлен веб-браузер Edge/Chrome/Firefox/Safari последних версий;
- Установлен [КриптоПро CSP 5.0](https://cryptopro.ru/products/csp/downloads);
- Установлен плагин веб-браузера [КриптоПро ЭЦП Browser plug-in](https://cryptopro.ru/products/cades/plugin);
- Установлен сертификат через КриптоПро и цепочку сертификатов ЦС.
  
Для согласования или подписания документов в Системе ЦДО ОМС подходит любой выданный аккредитованным удостоверяющим центром, действующий сертификат электронной подписи юридического лица с указанием физического лица (владельца сертификата), действующего от имени юридического лица на основании учредительных документов или доверенности. Сертификат используется для регистрации и входа в Систему ЦДО ОМС.

Для тестового ознакомления с ЦДО ОМС можно получить тестовый сертификат, следуя инструкциям по ссылке: [https://www.cryptopro.ru/certsrv/](https://www.cryptopro.ru/certsrv/).
# 2	ИНСТАЛЛЯЦИЯ ЦДО ОМС
## 2.1	ПОДГОТОВКА К ИНСТАЛЛЯЦИИ 
Все файлы необходимы для разворачивания ЦДО ОМС расположены в репозитории по адресу:
[https://github.com/vitacore-company/edo-demo](https://github.com/vitacore-company/edo-demo)

Необходимо скачать их и разархивировать в пустую папку, далее «рабочая папка» или «WorkDir».
В состав пакет входят файлы:
- docker-compose.yml – файл для запуска ЦДО ОМС
- .env – файл с переменными среды, для запуска ЦДО ОМС
- Dockerfile_postgres – файл для создания образа с СУБД Рostgres
- postgres_runner.sh – файл для настройки настройки СУБД Рostgres
- Dockerfile_samba файл для создания образа с samba-сервером
- smb.conf – файл конфигурации samba-срвера.

Перед запуском ЦДО ОМС переменным среды POSTGRES_PASSWORD (пароль пользователя СУБД) и SAMBA_PASS (пароль пользователя samba-сервера) необходимо задать значения. Это можно сделать средствами операционной системы или же редактированием файла .env, например, POSTGRES_PASSWORD=Password_01 и SAMBA_PASS=Password_02.

Остальные переменные заданы в файле .env определены и обозначают:
- TAG=latest – тег образа ЦДО ОМС (vitacore/edotfoms:latest)
- POSTGRES_USER=edo – пользователь СУБД
- POSTGRES_DB=EdoFoms – имя БД
- PORT5432=5432 – порт для СУБД
- PORT5005=5005 и PORT5006=5006 – порты для доступа к приложению ЦДО ОМС
- PORT445=445, PORT139=139, PORT138=138 и PORT137=137 порты для samba-сервера
- ASPNETCORE_URLS=https://+:5005;http://+:5006 – прослушиваемые приложением порты.
## 2.2	ЗАПУСК ЦДО ОМС
Выполняется на стороне сервера.
Открыть консоль командной строки. Перейти в рабочую папку
```
cd «WorkDir»
```
Загрузить необходимые образы командой:
```
docker-compose -f docker-compose.yml pull
```
Запустить приложение командой:
```
docker-compose -f docker-compose.yml up –d --build
```
Остановить приложение командой:
```
docker-compose -f docker-compose.yml down
```
Сбросить все данные и настройки системы до первоначальных командой:
```
docker-compose -f docker-compose.yml down -v
```
# 3	ПЕРВОНАЧАЛЬНАЯ НАСТРОЙКА СИСТЕМЫ
## 3.1	ВХОД И РЕГИСТРАЦИЯ В СИСТЕМЕ ЦДО ОМС
После запуска приложения на стороне сервера командой «docker-compose -f docker-compose.yml up -d --build» Можно выполнить вход в систему ЦДО ОМС на стороне пользователя:
- Открыть браузер
- Ввести ссылку ({PORT5005} – значение указанное в файле .env):
  -  https://localhost:{PORT5005}, если роли сервера и пользователя объединены на одной машине;
  - https://«IP_адрес_сервера»:{PORT5005}, если сервер и пользователь – разные машины.
  
  И перейдите по ней.
- Откроется окно вида 
 ![](/src/1.png) 
## 3.2	ДЕЙСТВИЯ РУКОВОДИТЕЛЯ ОРГАНИЗАЦИИ 
Регистрации организации и ее руководителя в ЦДО ОМС:
- На стартовой странице нажмите кнопку «Выбрать сертификат»;
- Выберите сертификат ЭП руководителя организации;
![](/src/2.png)
- Введите ИНН вашей организации (десятизначное значение);
- Выберите вид организации и нажмите кнопку «Далее»:
![](/src/3.png)
- Подтвердите, что вы руководитель организации:
![](/src/4.png)
- Проверьте наименование организации и нажмите кнопку «Записать»:
 ![](/src/5.png)

Система зарегистрирует организацию и руководителя организации, оповестив о положительном действии в правом верхнем углу экрана.
 ![](/src/6.png)

Далее при выборе сертификата и нажатии на кнопку «Авторизоваться»:
![](/src/7.png), 

в верхнем правом углу появится сообщение, о невозможности войти в систему.
 ![](/src/8.png)

Чтобы исправить данную ситуацию необходимо выполнить активацию организации и руководителя.
## 3.3	АКТИВАЦИЯ ОРГАНИЗАЦИИ И РУКОВОДИТЕЛЯ
Для активации организации и руководителя в командной строке на стороне сервера необходимо выполнить команду, подставив в {} соответствующие значения из файла .env:
```
docker exec -it edotfoms_db psql -d {POSTGRES_DB} -U {POSTGRES_USER} -f '/scripts/db_config.sql'
```
При удачном выполнении команды, командная строка вернет ответ:
```
UPDATE 2
UPDATE 2
INSERT 0 2
```
Теперь при выборе сертификата и нажатии на кнопку «Авторизоваться», в верхнем правом углу появится сообщение и выполнится вход в систему:
 ![](/src/9.png)
## 3.4	ПРОВЕРКА РУКОВОДИТЕЛЕМ ДАННЫХ ОБ ОРГАНИЗАЦИИ.
После успешной активации организации и руководителя организации, руководитель осуществляет вход в систему, проверяет реквизиты организации, выбрав пункт «Реквизиты» в левой стороне экрана:

 ![](/src/10.png)

Руководитель организации имеет возможность скорректировать номер телефона и e-mail организации, активировать вновь зарегистрировавшихся в ЦДО ОМС сотрудников своей организации.
Дальнейшие действия описаны в руководстве пользователя.
